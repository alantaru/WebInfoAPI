plugins {
    id 'java'
}

group = 'com.meuservidor'
version = '1.0.0'

java {
    sourceCompatibility = JavaVersion.VERSION_1_8
    targetCompatibility = JavaVersion.VERSION_1_8
}

repositories {
    mavenCentral()
    maven {
        name = 'Necesse Repository'
        url = 'https://maven.necesse-game.com/'
    }
}

dependencies {
    // Necesse API - versÃ£o pode variar
    compileOnly 'necesse:necesse:0.21.20'
    
    // OSHI para telemetria do sistema
    implementation 'com.github.oshi:oshi-core:6.4.8'
    
    // DependÃªncias para testes (opcional)
    testImplementation 'junit:junit:4.13.2'
}

jar {
    from configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
    
    manifest {
        attributes(
            'Main-Class': 'com.meuservidor.webapi.WebInfoAPI'
        )
    }
    
    // Incluir recursos
    from('src/main/resources') {
        include '**/*'
    }
}

// Task para compilar e testar
task testBuild(type: JavaCompile) {
    source = sourceSets.main.java
    classpath = configurations.compileClasspath
    destinationDirectory = file("$buildDir/test-classes")
    
    doLast {
        println "âœ… CompilaÃ§Ã£o bem-sucedida!"
        println "ğŸ“ Classes compiladas em: $destinationDirectory"
        
        // Verificar se o arquivo de configuraÃ§Ã£o foi incluÃ­do
        def configFile = file("$buildDir/resources/main/webapi.properties")
        if (configFile.exists()) {
            println "âœ… Arquivo webapi.properties incluÃ­do no build"
        } else {
            println "âŒ Arquivo webapi.properties NÃƒO encontrado"
        }
    }
}

// Task para verificar configuraÃ§Ãµes
task checkConfig {
    doLast {
        def configFile = file('src/main/resources/webapi.properties')
        if (configFile.exists()) {
            println "âœ… Arquivo de configuraÃ§Ã£o encontrado:"
            println "ğŸ“ LocalizaÃ§Ã£o: ${configFile.absolutePath}"
            println "ğŸ“„ ConteÃºdo:"
            configFile.eachLine { line ->
                if (!line.startsWith('#') && line.trim()) {
                    println "   $line"
                }
            }
        } else {
            println "âŒ Arquivo webapi.properties nÃ£o encontrado!"
        }
    }
}

// Task para validar estrutura do projeto
task validateProject {
    doLast {
        def requiredFiles = [
            'src/main/java/com/meuservidor/webapi/WebInfoAPI.java',
            'src/main/resources/webapi.properties',
            'src/main/resources/mod.info'
        ]
        
        println "ğŸ” Validando estrutura do projeto..."
        
        requiredFiles.each { filePath ->
            def file = file(filePath)
            if (file.exists()) {
                println "âœ… $filePath"
            } else {
                println "âŒ $filePath - AUSENTE"
            }
        }
        
        println "\nğŸ“Š Resumo da validaÃ§Ã£o:"
        def existingFiles = requiredFiles.count { file(it).exists() }
        println "   Arquivos encontrados: $existingFiles/${requiredFiles.size()}"
        
        if (existingFiles == requiredFiles.size()) {
            println "ğŸ‰ Projeto estÃ¡ completo e pronto para compilaÃ§Ã£o!"
        } else {
            println "âš ï¸  Alguns arquivos estÃ£o ausentes. Verifique a estrutura."
        }
    }
}

// Executar validaÃ§Ãµes antes do build
build.dependsOn validateProject
build.dependsOn checkConfig